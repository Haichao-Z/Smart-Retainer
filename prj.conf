# Zephyr Project Configuration for Smart Retainer MVP
# Target: nRF7002 DK (nRF5340) with BNO055 IMU
# Fixed: BLE reconnection and memory issues

# ========== Logging ==========
CONFIG_LOG=y
CONFIG_LOG_DEFAULT_LEVEL=3
CONFIG_SENSOR_LOG_LEVEL_DBG=y
CONFIG_LOG_BUFFER_SIZE=4096
CONFIG_LOG_MODE_DEFERRED=y

# ========== Hardware ==========
CONFIG_I2C=y
CONFIG_SENSOR=y
CONFIG_GPIO=y

# ========== BLE Configuration ==========
CONFIG_BT=y
CONFIG_BT_PERIPHERAL=y
CONFIG_BT_DEVICE_NAME="SmartRetainer"
CONFIG_BT_DEVICE_APPEARANCE=833
# CONFIG_BT_CONN=y
# CONFIG_BT_GATT_SERVICE=y
CONFIG_BT_HCI_ACL_FLOW_CONTROL=y
# # GATT Configuration
CONFIG_BT_MAX_CONN=1
CONFIG_BT_MAX_PAIRED=1
CONFIG_BT_GATT_DYNAMIC_DB=y
CONFIG_BT_GATT_CLIENT=y
CONFIG_BT_L2CAP_TX_BUF_COUNT=8
CONFIG_BT_ATT_TX_COUNT=8

# # BLE Stack Sizes
CONFIG_BT_RX_STACK_SIZE=4096

# IPC 工作队列栈大小 (关键!)
CONFIG_IPC_SERVICE_BACKEND_RPMSG_WQ_STACK_SIZE=2048

# ========== BLE Buffer Configuration (KEY FIX for ENOMEM) ==========
# 增加 BLE ACL 缓冲区
# CONFIG_BT_BUF_ACL_TX_COUNT=8
# CONFIG_BT_BUF_ACL_TX_SIZE=251
# CONFIG_BT_BUF_ACL_RX_COUNT=8
# CONFIG_BT_BUF_ACL_RX_SIZE=251

# 允许广播
# CONFIG_BT_BROADCASTER=y

# Connection parameters
# CONFIG_BT_PERIPHERAL_PREF_MIN_INT=6
# CONFIG_BT_PERIPHERAL_PREF_MAX_INT=12
# CONFIG_BT_PERIPHERAL_PREF_LATENCY=0
# CONFIG_BT_PERIPHERAL_PREF_TIMEOUT=400

# ========== Thread Stack Sizes ==========
CONFIG_MAIN_STACK_SIZE=11264
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=11264
CONFIG_IDLE_STACK_SIZE=2048
CONFIG_ISR_STACK_SIZE=2048

# ========== Memory Configuration (CRITICAL FOR ENOMEM FIX) ==========
# 从 16KB 增加到 32KB
CONFIG_HEAP_MEM_POOL_SIZE=65536

# ========== Math & Float Support ==========
CONFIG_NEWLIB_LIBC=y
CONFIG_NEWLIB_LIBC_FLOAT_PRINTF=y
CONFIG_FPU=y
CONFIG_FPU_SHARING=y

# ========== Compiler & Debug ==========
CONFIG_DEBUG=y
CONFIG_NO_OPTIMIZATIONS=y

# ========== Stack Protection ==========
CONFIG_MPU_STACK_GUARD=y
CONFIG_THREAD_STACK_INFO=y
CONFIG_THREAD_MONITOR=y
CONFIG_THREAD_NAME=y

# ========== IPC Configuration ==========
CONFIG_IPC_SERVICE=y
CONFIG_MBOX=y

# ========== Assert ==========
CONFIG_ASSERT=y
CONFIG_ASSERT_LEVEL=2

# ========== BLE Connection Manager ==========
# CONFIG_BT_CONN_CTX=y
# CONFIG_BT_CONN=y
# CONFIG_BT_CTLR_DATA_LENGTH=y
# CONFIG_NCS_SAMPLES_DEFAULTS=y
# CONFIG_BT_CTLR_DATA_LENGTH_MAX=251
CONFIG_BT_BUF_ACL_RX_SIZE=251
CONFIG_BT_BUF_ACL_TX_SIZE=251
# CONFIG_BT_RX_BUF_LEN=258
# CONFIG_BT=y
# CONFIG_BT_PERIPHERAL=y
# CONFIG_BT_DEVICE_NAME="Nordic_LBS"

# Enable the LBS service
# CONFIG_BT_LBS=y
# CONFIG_BT_LBS_POLL_BUTTON=y
# CONFIG_DK_LIBRARY=y

# CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=2048

# Step 2.2 - Enable FOTA over Bluetooth LE
CONFIG_NCS_SAMPLE_MCUMGR_BT_OTA_DFU=y


####################################################
# ========== DFU / MCUBoot 启用 ==========
# (根据你的链接) 告诉系统构建并使用 MCUBoot
CONFIG_BOOTLOADER_MCUBOOT=y

# CONFIG_GPIO=y
# STEP 5.2 - Enable mcumgr DFU in application
# Enable MCUMGR 
CONFIG_MCUMGR=y

# Enable MCUMGR management for both OS and Images
CONFIG_MCUMGR_GRP_OS=y
CONFIG_MCUMGR_GRP_IMG=y

# Configure MCUMGR transport to UART
CONFIG_MCUMGR_TRANSPORT_UART=y

# --- 启用蓝牙 (BLE) 传输 ---
# 这会自动拉入所有必需的蓝牙依赖项 (如 GATT)
CONFIG_MCUMGR_TRANSPORT_BT=y

# --- 为 MCUMgr 传输工作队列设置栈大小 (修复你的堆栈溢出) ---
# 这是所有传输 (BLE, UART等) 共享的栈
CONFIG_MCUMGR_TRANSPORT_WORKQUEUE_STACK_SIZE=4096

# Dependencies
# Configure dependencies for CONFIG_MCUMGR  
CONFIG_NET_BUF=y
CONFIG_ZCBOR=y
CONFIG_CRC=y

# Configure dependencies for CONFIG_MCUMGR_GRP_IMG  
CONFIG_FLASH=y
CONFIG_IMG_MANAGER=y

# Configure dependencies for CONFIG_IMG_MACONFIG_BOOT_SWAP_USING_EXTERNAL_FLASH=yNAGER  
CONFIG_STREAM_FLASH=y
CONFIG_FLASH_MAP=y

# Configure dependencies for CONFIG_MCUMGR_TRANSPORT_UART 
CONFIG_BASE64=y

# STEP 1.1 - Enable QSPI driver for Application
# CONFIG_NORDIC_QSPI_NOR=y
# Step 1.1 - Enable SPI driver for the application
CONFIG_GPIO=y
CONFIG_SPI=y
CONFIG_SPI_NOR=y
CONFIG_SPI_NOR_SFDP_DEVICETREE=y
CONFIG_SPI_NOR_FLASH_LAYOUT_PAGE_SIZE=4096
# QSPI drivers are enabled by defualt for some chips.
# Disable it explicitly to be sure QSPI is disabled.
CONFIG_NORDIC_QSPI_NOR=n 