# Zephyr Project Configuration for Smart Retainer MVP
# Target: nRF7002 DK (nRF5340) with BNO055 IMU
# Fixed: BLE reconnection and memory issues

# ========== Logging ==========
CONFIG_LOG=y
CONFIG_LOG_DEFAULT_LEVEL=3
CONFIG_SENSOR_LOG_LEVEL_DBG=y
CONFIG_LOG_BUFFER_SIZE=4096

# ========== Hardware ==========
CONFIG_I2C=y
CONFIG_SENSOR=y
CONFIG_GPIO=y

# ========== BLE Configuration ==========
CONFIG_BT=y
CONFIG_BT_PERIPHERAL=y
CONFIG_BT_DEVICE_NAME="SmartRetainer"
CONFIG_BT_DEVICE_APPEARANCE=833

# GATT Configuration
CONFIG_BT_MAX_CONN=1
CONFIG_BT_L2CAP_TX_BUF_COUNT=8
CONFIG_BT_ATT_TX_COUNT=8

# BLE Stack Sizes
CONFIG_BT_RX_STACK_SIZE=4096

# IPC 工作队列栈大小 (关键!)
CONFIG_IPC_SERVICE_BACKEND_RPMSG_WQ_STACK_SIZE=2048

# ========== BLE Buffer Configuration (KEY FIX for ENOMEM) ==========
# 增加 BLE ACL 缓冲区
CONFIG_BT_BUF_ACL_TX_COUNT=8
CONFIG_BT_BUF_ACL_TX_SIZE=251
CONFIG_BT_BUF_ACL_RX_COUNT=8
CONFIG_BT_BUF_ACL_RX_SIZE=251

# 允许广播
CONFIG_BT_BROADCASTER=y

# Connection parameters
CONFIG_BT_PERIPHERAL_PREF_MIN_INT=6
CONFIG_BT_PERIPHERAL_PREF_MAX_INT=12
CONFIG_BT_PERIPHERAL_PREF_LATENCY=0
CONFIG_BT_PERIPHERAL_PREF_TIMEOUT=400

# ========== Thread Stack Sizes ==========
CONFIG_MAIN_STACK_SIZE=8192
CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=8192
CONFIG_IDLE_STACK_SIZE=2048
CONFIG_ISR_STACK_SIZE=2048

# ========== Memory Configuration (CRITICAL FOR ENOMEM FIX) ==========
# 从 16KB 增加到 32KB
CONFIG_HEAP_MEM_POOL_SIZE=32768

# ========== Math & Float Support ==========
CONFIG_NEWLIB_LIBC=y
CONFIG_NEWLIB_LIBC_FLOAT_PRINTF=y
CONFIG_FPU=y
CONFIG_FPU_SHARING=y

# ========== Compiler & Debug ==========
CONFIG_DEBUG=y
CONFIG_NO_OPTIMIZATIONS=y

# ========== Stack Protection ==========
CONFIG_MPU_STACK_GUARD=y
CONFIG_THREAD_STACK_INFO=y
CONFIG_THREAD_MONITOR=y
CONFIG_THREAD_NAME=y

# ========== IPC Configuration ==========
CONFIG_IPC_SERVICE=y
CONFIG_MBOX=y

# ========== Assert ==========
CONFIG_ASSERT=y
CONFIG_ASSERT_LEVEL=2

# ========== BLE Connection Manager ==========
CONFIG_BT_CONN_CTX=y